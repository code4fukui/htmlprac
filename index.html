<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ES-Jam 〜Webプログラミング道場〜</title>
    <style>
    @media only screen and (max-width: 1050px) {
        #subtitle {
            display: none;
        }
    }
    </style>
</head>

<body style="height:100vh;font-family:sans-serif;">
    <div style="height:3em;">
        <div style="float:right; ">
            <button id=btnrun style="font-size:1.2em;">見てみる (^S)</button>
            <button id=btnsave style="font-size:1.2em;">SAVEする<a id="elmSave"></a></button>
            <button id=btnload style="font-size:1.2em;">LOADする<input id="elmLoad" type="file" hidden></button>
            <button id=btnup style="font-size:1.2em;">UPする</button>
            <!--
                <button id=btnshare title="シェアする" style="font-size:1.2em;">📤</button>
            -->
        </div>
        <h1 style="font-size:1.5em;white-space:nowrap;">
            ES-Jam <span id=subtitle style="font-size:66%;">〜Webプログラミング道場〜</span>
            <select style="margin-left:.5em;padding:.2em;" id="seltemplate"></select>
        </h1>
    </div>
    <div style="height:calc(100vh - 8em);">
        <div style="float:left; width:50%; height:100%;" id="elmEditor"></div>
        <div style="float:right; width:50%; height:100%;">
            <iframe id="elmPreview" style="width:100%; height:100%;" src="data:text/html;charset=utf-8;base64,5bem5YG0KOOCqOODh+OCo+OCvynjgatIVE1M44KS5pu444GE44Gm44CM6KaL44Gm44G/44KL44CN44Oc44K/44Oz44KS44CC"></iframe>
        </div>
    </div>
    <div style="">
        <span id=qrcontainer style=""></span>
        <span id=publishurl style="display: inline-block; padding-top: 15px; vertical-align: top;"></span>
        <div style="float:right;padding-top:15px;">
            v20230210 by <a href="https://github.com/code4fukui/htmlprac" target="_blank">Code for FUKUI</a>
        </div>
    </div>

    <script type="module">
        import { monaco } from "https://code4fukui.github.io/monaco-editor/monaco.js";
        //import { fixMyHTML } from "https://code4fukui.github.io/fixMyHTML/fixMyHTML.js";
        import { ZenkakuAlpha } from "https://code4fukui.github.io/mojikiban/ZenkakuAlpha.js";
        import { QRCode } from "https://js.sabae.cc/QRCode.js";
        //import { fetchJSON } from "https://js.sabae.cc/fetchJSON.js";
        const fetchText = async (url, req) => {
            const opt = req ? {
                method: "POST",
                mode: "cors",
                //mode: "no-cors",
                cache: "no-cache",
                //headers: { "Content-Type": "application/json" },
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(req),
                //body: encodeURIComponent(req),
            } : null;
            const res = await (await fetch(url, opt)).text();
            return res;
        };
        const showUpURL = (upurl, no) => {
            qrcontainer.innerHTML = "";
            qrcontainer.appendChild(new QRCode(upurl, 2));
            location.hash = "#" + no;
            //publishurl.innerHTML = `公開されたURL<br><a href=${upurl}>${upurl}</a>`;
            publishurl.innerHTML = `<a href=${upurl}>${upurl}</a>`;
        };

        let g_editor;

        async function エディタを作る() {
            g_editor = monaco.editor.create(elmEditor, {
                language: "html",
                //autoIndent: true,
                autoIndent: "none",
                //formatOnPaste: true,
                //formatOnType: true,
                tabSize: 2,
                minimap: { enabled: false },
                //overflow: "auto",
                automaticLayout: true,
                theme: "vs-dark",
            });

            let prg = "";
            const url = (new URL(document.location.href)).searchParams.get("url");
            if (url) {
                prg += await (await fetch(url)).text();
                prg += "\n";
            }
            //const n = (new URL(document.location.href)).searchParams.get("n");
            const n = parseInt(document.location.hash.substring(1));
            if (!isNaN(n)) {
                if (n) {
                    const url = "https://ss.sabae.cc/" + n + ".html";
                    prg += await (await fetch(url)).text();
                    prg += "\n";
                    showUpURL(url, n);
                } else {
                    prg = "\n";
                }
            }
            //prg += decodeURIComponent(location.hash.substr(1)).replaceAll('scr.ES-Jam.ipt','script');
            if (!prg) {
                const p1 = localStorage.getItem("program");
                if (p1) {
                    prg = p1;
                }
            }
            g_editor.setValue(prg);

            elmEditor.addEventListener("keyup", (e) => {
                if (e.ctrlKey && e.key == "s") {
                    見てみる();
                    // elmPreview.focus();
                }
            });
            if (prg) {
                見てみる();
            }
        }

        function 見てみる() {
            const p1 = g_editor.getValue();
            //const p2 = fixMyHTML(p1); // ヒアドキュメントなどコードの一部がおかしくなる
            const p2 = ZenkakuAlpha.toHan(p1);
            if (p1 != p2) {
                g_editor.setValue(p2);
                //alert("全角文字を半角文字に置き換えました");
            }
            localStorage.setItem("program", g_editor.getValue());
            //g_editor.getAction("editor.action.formatDocument").run();
            elmPreview.src = URL.createObjectURL(new Blob([g_editor.getValue()], { type: "text/html" }));
        }

        function SAVEする() {
            elmSave.download = `WebDOJO.${Date.now()}.html`;
            elmSave.href = URL.createObjectURL(new Blob([g_editor.getValue()], { type: "application/octet-stream" }));
            elmSave.click();
        }

        function LOADする() {
            const f = new FileReader();
            f.onload = () => {
                g_editor.setValue(f.result);
            };
            f.readAsText(elmLoad.files[0]);
        }

        function シェアする() {
            const code = encodeURIComponent(g_editor.getValue().replaceAll('script','scr.ES-Jam.ipt')).replaceAll('(','%28').replaceAll(')','%29').replaceAll("'",'%27');
            navigator.clipboard.writeText(`${location.origin}${location.pathname}#${code}`);
            alert('シェア用URLをクリップボードにコピーしました');
        }
        async function UPする() {
            btnup.disabled = true;
            const code = g_editor.getValue();
            const url = "https://ss.sabae.cc/"
            const res = await fetchText(url + "api/", code);
            if (isNaN(parseInt(res))) {
                alert(res);
            } else {
                const upurl = url + res + ".html";
                //prompt("公開されたURL", upurl);
                showUpURL(upurl, res);
            }
            btnup.disabled = false;
        }
        // init
        btnrun.onclick = () => 見てみる();
        elmLoad.onchange = () => LOADする();
        btnload.onclick = () => elmLoad.click();
        btnsave.onclick = () => SAVEする();
        btnup.onclick = () => UPする();
        //btnshare.onclick = () => シェアする();
        エディタを作る();

        // サポート
        const script = "script";
        const templates = {
            "ウェブアプリ開発サポート": "",
            "タイトル h1": "<h1>タイトル</h1>\n",
            "テキスト": "テキスト\n",
            "改行 br": "<br>\n",
            "色付きテキスト font": "<font color=red>あかいもじ</font>\n",
            "区切り線 hr": "<hr>\n",
            "リンク a": "<a href=https://jig.jp/>jig.jp</a>\n",
            "背景色 bgcolor": "<body bgcolor=green>\n",
            "リンクの色 css": "<style>a { color: gray !important }</style>\n",
            "JavaScript script": "<" + "script>\nalert(1 + 1);\n</" + "script>\n",
            "ノベルゲーム テンプレ egadv": `<${script} type="module">
import { bg, show } from "https://js.sabae.cc/egadv.js";
await bg();
await show("ここはどこだろう?");
await show("福井かな?");
</${script}>`,
            "地図表示 for egadv": "await bg(“E9138732”);\n",
            "ランダム福井県写真 for egadv": "await bg(“福井県”);\n",
            "VRアプリ テンプレ egvr": `<${script} type="module">
import * as eg from "https://js.sabae.cc/egvr.js";

// x, y, z, size, color
eg.sphere(0, 1, -2, 0.5, "red")
eg.box(1, 1, -2, 0.5, "blue")
eg.box(-1, 1, -2, 0.5, "yellow")
</${script}>`,
            "スマホ対応 viewport": `<meta name="viewport" content="width=device-width">`,
        };
        for (const name in templates) {
            const op = document.createElement("option");
            op.textContent = name;
            op.value = templates[name];
            seltemplate.appendChild(op);
        }
        g_editor.insertText = (text) => {
            const selection = g_editor.getSelection();
            const id = { major: 1, minor: 1 };             
            const op = {identifier: id, range: selection, text, forceMoveMarkers: true};
            g_editor.executeEdits("my-source", [op]);
        };
        seltemplate.oninput = (event) => {
            const text = seltemplate.value;
            if (text.startsWith("<meta ")) { // } || text.startsWith("<script")) {
                g_editor.setValue(text + "\n" + g_editor.getValue());
            } else {
                g_editor.insertText(text);
            }
            seltemplate.value = "";
        };
    </script>
</body>

</html>
