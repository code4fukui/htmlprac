<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ES-Jam ã€œWebãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°é“å ´ã€œ</title>
    <style>
    @media only screen and (max-width: 1050px) {
        #subtitle {
            display: none;
        }
    }
    </style>
</head>

<body style="height:100vh;font-family:sans-serif;">
    <div style="height:3em;">
        <div style="float:right; ">
            <button id=btnrun style="font-size:1.2em;">è¦‹ã¦ã¿ã‚‹ (^S)</button>
            <button id=btnsave style="font-size:1.2em;">SAVEã™ã‚‹<a id="elmSave"></a></button>
            <button id=btnload style="font-size:1.2em;">LOADã™ã‚‹<input id="elmLoad" type="file" hidden></button>
            <button id=btnup style="font-size:1.2em;">UPã™ã‚‹</button>
            <!--
                <button id=btnshare title="ã‚·ã‚§ã‚¢ã™ã‚‹" style="font-size:1.2em;">ğŸ“¤</button>
            -->
        </div>
        <h1 style="font-size:1.5em;white-space:nowrap;">
            ES-Jam <span id=subtitle style="font-size:66%;">ã€œWebãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°é“å ´ã€œ</span>
            <select style="margin-left:.5em;padding:.2em;" id="seltemplate"></select>
        </h1>
    </div>
    <div style="height:calc(100vh - 8em);">
        <div style="float:left; width:50%; height:100%;" id="elmEditor"></div>
        <div style="float:right; width:50%; height:100%;">
            <iframe id="elmPreview" style="width:100%; height:100%;" src="data:text/html;charset=utf-8;base64,5bem5YG0KOOCqOODh+OCo+OCvynjgatIVE1M44KS5pu444GE44Gm44CM6KaL44Gm44G/44KL44CN44Oc44K/44Oz44KS44CC"></iframe>
        </div>
    </div>
    <div style="">
        <span id=qrcontainer style=""></span>
        <span id=publishurl style="display: inline-block; padding-top: 15px; vertical-align: top;"></span>
        <div style="float:right;padding-top:15px;">
            v20230210 by <a href="https://github.com/code4fukui/htmlprac" target="_blank">Code for FUKUI</a>
        </div>
    </div>

    <script type="module">
        import { monaco } from "https://code4fukui.github.io/monaco-editor/monaco.js";
        //import { fixMyHTML } from "https://code4fukui.github.io/fixMyHTML/fixMyHTML.js";
        import { ZenkakuAlpha } from "https://code4fukui.github.io/mojikiban/ZenkakuAlpha.js";
        import { QRCode } from "https://js.sabae.cc/QRCode.js";
        //import { fetchJSON } from "https://js.sabae.cc/fetchJSON.js";
        const fetchText = async (url, req) => {
            const opt = req ? {
                method: "POST",
                mode: "cors",
                //mode: "no-cors",
                cache: "no-cache",
                //headers: { "Content-Type": "application/json" },
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(req),
                //body: encodeURIComponent(req),
            } : null;
            const res = await (await fetch(url, opt)).text();
            return res;
        };
        const showUpURL = (upurl, no) => {
            qrcontainer.innerHTML = "";
            qrcontainer.appendChild(new QRCode(upurl, 2));
            location.hash = "#" + no;
            //publishurl.innerHTML = `å…¬é–‹ã•ã‚ŒãŸURL<br><a href=${upurl}>${upurl}</a>`;
            publishurl.innerHTML = `<a href=${upurl}>${upurl}</a>`;
        };

        let g_editor;

        async function ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½œã‚‹() {
            g_editor = monaco.editor.create(elmEditor, {
                language: "html",
                //autoIndent: true,
                autoIndent: "none",
                //formatOnPaste: true,
                //formatOnType: true,
                tabSize: 2,
                minimap: { enabled: false },
                //overflow: "auto",
                automaticLayout: true,
                theme: "vs-dark",
            });

            let prg = "";
            const url = (new URL(document.location.href)).searchParams.get("url");
            if (url) {
                prg += await (await fetch(url)).text();
                prg += "\n";
            }
            //const n = (new URL(document.location.href)).searchParams.get("n");
            const n = parseInt(document.location.hash.substring(1));
            if (!isNaN(n)) {
                if (n) {
                    const url = "https://ss.sabae.cc/" + n + ".html";
                    prg += await (await fetch(url)).text();
                    prg += "\n";
                    showUpURL(url, n);
                } else {
                    prg = "\n";
                }
            }
            //prg += decodeURIComponent(location.hash.substr(1)).replaceAll('scr.ES-Jam.ipt','script');
            if (!prg) {
                const p1 = localStorage.getItem("program");
                if (p1) {
                    prg = p1;
                }
            }
            g_editor.setValue(prg);

            elmEditor.addEventListener("keyup", (e) => {
                if (e.ctrlKey && e.key == "s") {
                    è¦‹ã¦ã¿ã‚‹();
                    // elmPreview.focus();
                }
            });
            if (prg) {
                è¦‹ã¦ã¿ã‚‹();
            }
        }

        function è¦‹ã¦ã¿ã‚‹() {
            const p1 = g_editor.getValue();
            //const p2 = fixMyHTML(p1); // ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã©ã‚³ãƒ¼ãƒ‰ã®ä¸€éƒ¨ãŒãŠã‹ã—ããªã‚‹
            const p2 = ZenkakuAlpha.toHan(p1);
            if (p1 != p2) {
                g_editor.setValue(p2);
                //alert("å…¨è§’æ–‡å­—ã‚’åŠè§’æ–‡å­—ã«ç½®ãæ›ãˆã¾ã—ãŸ");
            }
            localStorage.setItem("program", g_editor.getValue());
            //g_editor.getAction("editor.action.formatDocument").run();
            elmPreview.src = URL.createObjectURL(new Blob([g_editor.getValue()], { type: "text/html" }));
        }

        function SAVEã™ã‚‹() {
            elmSave.download = `WebDOJO.${Date.now()}.html`;
            elmSave.href = URL.createObjectURL(new Blob([g_editor.getValue()], { type: "application/octet-stream" }));
            elmSave.click();
        }

        function LOADã™ã‚‹() {
            const f = new FileReader();
            f.onload = () => {
                g_editor.setValue(f.result);
            };
            f.readAsText(elmLoad.files[0]);
        }

        function ã‚·ã‚§ã‚¢ã™ã‚‹() {
            const code = encodeURIComponent(g_editor.getValue().replaceAll('script','scr.ES-Jam.ipt')).replaceAll('(','%28').replaceAll(')','%29').replaceAll("'",'%27');
            navigator.clipboard.writeText(`${location.origin}${location.pathname}#${code}`);
            alert('ã‚·ã‚§ã‚¢ç”¨URLã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
        }
        async function UPã™ã‚‹() {
            btnup.disabled = true;
            const code = g_editor.getValue();
            const url = "https://ss.sabae.cc/"
            const res = await fetchText(url + "api/", code);
            if (isNaN(parseInt(res))) {
                alert(res);
            } else {
                const upurl = url + res + ".html";
                //prompt("å…¬é–‹ã•ã‚ŒãŸURL", upurl);
                showUpURL(upurl, res);
            }
            btnup.disabled = false;
        }
        // init
        btnrun.onclick = () => è¦‹ã¦ã¿ã‚‹();
        elmLoad.onchange = () => LOADã™ã‚‹();
        btnload.onclick = () => elmLoad.click();
        btnsave.onclick = () => SAVEã™ã‚‹();
        btnup.onclick = () => UPã™ã‚‹();
        //btnshare.onclick = () => ã‚·ã‚§ã‚¢ã™ã‚‹();
        ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½œã‚‹();

        // ã‚µãƒãƒ¼ãƒˆ
        const script = "script";
        const templates = {
            "ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªé–‹ç™ºã‚µãƒãƒ¼ãƒˆ": "",
            "ã‚¿ã‚¤ãƒˆãƒ« h1": "<h1>ã‚¿ã‚¤ãƒˆãƒ«</h1>\n",
            "ãƒ†ã‚­ã‚¹ãƒˆ": "ãƒ†ã‚­ã‚¹ãƒˆ\n",
            "æ”¹è¡Œ br": "<br>\n",
            "è‰²ä»˜ããƒ†ã‚­ã‚¹ãƒˆ font": "<font color=red>ã‚ã‹ã„ã‚‚ã˜</font>\n",
            "åŒºåˆ‡ã‚Šç·š hr": "<hr>\n",
            "ãƒªãƒ³ã‚¯ a": "<a href=https://jig.jp/>jig.jp</a>\n",
            "èƒŒæ™¯è‰² bgcolor": "<body bgcolor=green>\n",
            "ãƒªãƒ³ã‚¯ã®è‰² css": "<style>a { color: gray !important }</style>\n",
            "JavaScript script": "<" + "script>\nalert(1 + 1);\n</" + "script>\n",
            "ãƒãƒ™ãƒ«ã‚²ãƒ¼ãƒ  ãƒ†ãƒ³ãƒ—ãƒ¬ egadv": `<${script} type="module">
import { bg, show } from "https://js.sabae.cc/egadv.js";
await bg();
await show("ã“ã“ã¯ã©ã“ã ã‚ã†?");
await show("ç¦äº•ã‹ãª?");
</${script}>`,
            "åœ°å›³è¡¨ç¤º for egadv": "await bg(â€œE9138732â€);\n",
            "ãƒ©ãƒ³ãƒ€ãƒ ç¦äº•çœŒå†™çœŸ for egadv": "await bg(â€œç¦äº•çœŒâ€);\n",
            "VRã‚¢ãƒ—ãƒª ãƒ†ãƒ³ãƒ—ãƒ¬ egvr": `<${script} type="module">
import * as eg from "https://js.sabae.cc/egvr.js";

// x, y, z, size, color
eg.sphere(0, 1, -2, 0.5, "red")
eg.box(1, 1, -2, 0.5, "blue")
eg.box(-1, 1, -2, 0.5, "yellow")
</${script}>`,
            "ã‚¹ãƒãƒ›å¯¾å¿œ viewport": `<meta name="viewport" content="width=device-width">`,
        };
        for (const name in templates) {
            const op = document.createElement("option");
            op.textContent = name;
            op.value = templates[name];
            seltemplate.appendChild(op);
        }
        g_editor.insertText = (text) => {
            const selection = g_editor.getSelection();
            const id = { major: 1, minor: 1 };             
            const op = {identifier: id, range: selection, text, forceMoveMarkers: true};
            g_editor.executeEdits("my-source", [op]);
        };
        seltemplate.oninput = (event) => {
            const text = seltemplate.value;
            if (text.startsWith("<meta ")) { // } || text.startsWith("<script")) {
                g_editor.setValue(text + "\n" + g_editor.getValue());
            } else {
                g_editor.insertText(text);
            }
            seltemplate.value = "";
        };
    </script>
</body>

</html>
