<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ES-Jam сђюWebсЃЌсЃГсѓ░сЃЕсЃЪсЃ│сѓ░жЂЊта┤сђю</title>
</head>

<body style="height:100vh;">
    <div style="height:3em;">
        <div style="float:right; ">
            <button id=btnrun style="font-size:1.2em;">УдІсЂдсЂ┐сѓІ (^S)</button>
            <button id=btnsave style="font-size:1.2em;">SAVEсЂЎсѓІ<a id="elmSave"></a></button>
            <button id=btnload style="font-size:1.2em;">LOADсЂЎсѓІ<input id="elmLoad" type="file" hidden></button>
            <button id=btnup style="font-size:1.2em;">UPсЂЎсѓІ</button>
            <!--
                <button id=btnshare title="сѓисѓДсѓбсЂЎсѓІ" style="font-size:1.2em;">­ЪЊц</button>
            -->
        </div>
        <h1 style="font-size:1.5em;">
            ES-Jam <span style="font-size:66%;">сђюWebсЃЌсЃГсѓ░сЃЕсЃЪсЃ│сѓ░жЂЊта┤сђю</span>
        </h1>
    </div>
    <div style="height:calc(100vh - 7em);">
        <div style="float:left; width:50%; height:100%;" id="elmEditor"></div>
        <div style="float:right; width:50%; height:100%;">
            <iframe id="elmPreview" style="width:100%; height:100%;" src="data:text/html;charset=utf-8;base64,5bem5YG0KOOCqOODh+OCo+OCvynjgatIVE1M44KS5pu444GE44Gm44CM6KaL44Gm44G/44KL44CN44Oc44K/44Oz44KS44CC"></iframe>
        </div>
    </div>
    <div style="padding-top:15px; ">
        <div style="float:right; ">
            v20220821 by <a href="https://github.com/code4fukui/htmlprac" target="_blank">Code for FUKUI</a>
        </div>
    </div>

    <script type="module">
        import { monaco } from "https://code4fukui.github.io/monaco-editor/monaco.js";
        import { fixMyHTML } from "https://code4fukui.github.io/fixMyHTML/fixMyHTML.js";
        //import { fetchJSON } from "https://js.sabae.cc/fetchJSON.js";
        const fetchText = async (url, req) => {
            const opt = req ? {
                method: "POST",
                mode: "cors",
                //mode: "no-cors",
                cache: "no-cache",
                //headers: { "Content-Type": "application/json" },
                headers: { "Content-Type": "text/plain" },
                body: JSON.stringify(req),
                //body: encodeURIComponent(req),
            } : null;
            const res = await (await fetch(url, opt)).text();
            return res;
        };

        let g_editor;

        async function сѓесЃЄсѓБсѓ┐сѓњСйюсѓІ() {
            g_editor = monaco.editor.create(elmEditor, {
                language: "html",
                //autoIndent: true,
                autoIndent: "none",
                //formatOnPaste: true,
                //formatOnType: true,
                tabSize: 2,
                minimap: { enabled: false },
                //overflow: "auto",
                automaticLayout: true,
                theme: "vs-dark",
            });

            let prg = "";
            const url = (new URL(document.location.href)).searchParams.get("url");
            if (url) {
                prg += await (await fetch(url)).text();
                prg += "\n";
            }
            //const n = (new URL(document.location.href)).searchParams.get("n");
            const n = parseInt(document.location.search.substring(1));
            if (!isNaN(n)) {
                const url = "https://ss.sabae.cc/" + n + ".html";
                prg += await (await fetch(url)).text();
                prg += "\n";
            }
            prg += decodeURIComponent(location.hash.substr(1)).replaceAll('scr.ES-Jam.ipt','script');
            g_editor.setValue(prg);

            elmEditor.addEventListener("keyup", (e) => {
                if (e.ctrlKey && e.key == "s") {
                    УдІсЂдсЂ┐сѓІ();
                    // elmPreview.focus();
                }
            });
        }

        function УдІсЂдсЂ┐сѓІ() {
            const p1 = g_editor.getValue();
            const p2 = fixMyHTML(p1);
            if (p1 != p2) {
                g_editor.setValue(p2);
                //alert("тЁеУДњТќЄтГЌсѓњтЇіУДњТќЄтГЌсЂФуй«сЂЇТЈЏсЂѕсЂЙсЂЌсЂЪ");
            }
            localStorage.setItem("program", g_editor.getValue());
            //g_editor.getAction("editor.action.formatDocument").run();
            elmPreview.src = URL.createObjectURL(new Blob([g_editor.getValue()], { type: "text/html" }));
        }

        function SAVEсЂЎсѓІ() {
            elmSave.download = `WebDOJO.${Date.now()}.html`;
            elmSave.href = URL.createObjectURL(new Blob([g_editor.getValue()], { type: "application/octet-stream" }));
            elmSave.click();
        }

        function LOADсЂЎсѓІ() {
            const f = new FileReader();
            f.onload = () => {
                g_editor.setValue(f.result);
            };
            f.readAsText(elmLoad.files[0]);
        }

        function сѓисѓДсѓбсЂЎсѓІ() {
            const code = encodeURIComponent(g_editor.getValue().replaceAll('script','scr.ES-Jam.ipt')).replaceAll('(','%28').replaceAll(')','%29').replaceAll("'",'%27');
            navigator.clipboard.writeText(`${location.origin}${location.pathname}#${code}`);
            alert('сѓисѓДсѓбућеURLсѓњсѓ»сЃфсЃЃсЃЌсЃюсЃ╝сЃЅсЂФсѓ│сЃћсЃ╝сЂЌсЂЙсЂЌсЂЪ');
        }
        async function UPсЂЎсѓІ() {
            const code = g_editor.getValue();
            const url = "https://ss.sabae.cc/"
            const res = await fetchText(url + "api/", code);
            if (isNaN(parseInt(res))) {
                alert(res);
            } else {
                prompt("тЁгжќІсЂЋсѓїсЂЪURL", url + res + ".html");
            }
        }
        // init
        btnrun.onclick = () => УдІсЂдсЂ┐сѓІ();
        elmLoad.onchange = () => LOADсЂЎсѓІ();
        btnload.onclick = () => elmLoad.click();
        btnsave.onclick = () => SAVEсЂЎсѓІ();
        btnup.onclick = () => UPсЂЎсѓІ();
        //btnshare.onclick = () => сѓисѓДсѓбсЂЎсѓІ();
        сѓесЃЄсѓБсѓ┐сѓњСйюсѓІ();

        const p1 = localStorage.getItem("program");
        if (p1) {
            g_editor.setValue(p1);
        }
    </script>
</body>

</html>
